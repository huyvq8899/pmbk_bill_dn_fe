<div>
    <nz-progress [nzPercent]="percentGuiEmail" nzStatus="active" *ngIf="selectedIndex === 1"></nz-progress>
</div>

<nz-spin [nzSpinning]="isLoading">
    <nz-tabset class="tab-set" [nzTabPosition]="'left'" [(nzSelectedIndex)]="selectedIndex"
        (nzSelectChange)="changeTab($event)">
        <nz-tab nzTitle="1. Chọn hóa đơn" [nzDisabled]="true">
            <div class="inner-content">
                <div class="filter-list-container">
                    <div class="ky-wrapper">
                        <div class="vertical-form-label">
                            <div>Kỳ</div>
                        </div>
                        <nz-select class="sl-filter" style="width: 100%;" nzSize="small" nzShowSearch
                            nzPlaceHolder="Chọn kỳ" [(ngModel)]="displayData.ky" (ngModelChange)="changeKy($event)">
                            <nz-option *ngFor="let item of kys" [nzLabel]="item.value" [nzValue]="item.key"></nz-option>
                        </nz-select>
                    </div>
                    <div class="ngay-wrapper">
                        <div class="vertical-form-label">
                            <div>Từ ngày</div>
                        </div>
                        <input class="txt-filter" style="width: 100%;" nzSize="small" max="2999-12-31" type="date"
                            nz-input [(ngModel)]="displayData.fromDate" (blur)="blurDate()" />
                    </div>
                    <div class="ngay-wrapper">
                        <div class="vertical-form-label">
                            <div>Đến ngày</div>
                        </div>
                        <input class="txt-filter" style="width: 100%;" nzSize="small" max="2999-12-31" type="date"
                            nz-input [(ngModel)]="displayData.toDate" (blur)="blurDate()" />
                    </div>
                    <div class="tim-kiem-theo-wrapper">
                        <div class="vertical-form-label">
                            <div>Tìm kiếm theo:</div>
                        </div>
                        <nz-form-item>
                            <nz-form-control [nzSm]="24" [nzXs]="24">
                                <div nz-col nzSpan="24">
                                    <nz-input-group [nzPrefix]="prefixTemplateUser" nzSize="small">
                                        <input class="txt-filter" type="text" [(ngModel)]="displayData.giaTri" nz-input
                                            [placeholder]="placeHolderTimKiemTheo()" nz-tooltip
                                            [nzTooltipTitle]="placeHolderTimKiemTheo() || null"
                                            nzTooltipPlacement="bottomRight" />
                                    </nz-input-group>
                                    <ng-template #prefixTemplateUser>
                                        <i nz-icon nzType="setting" nzTheme="outline" nz-dropdown
                                            [nzDropdownMenu]="menuPlusMutiple2" [nzClickHide]="false"></i>
                                        <nz-dropdown-menu #menuPlusMutiple2="nzDropdownMenu">
                                            <ul nz-menu>
                                                <li nz-menu-item *ngFor="let item of timKiemTheos">
                                                    <label ngClass='ckbcheckBox' nz-checkbox [(ngModel)]="item.checked"
                                                        [nzValue]="item.value"
                                                        (ngModelChange)="changeCheckboxTimKiemTheo($event)"
                                                        [ngModelOptions]="{standalone: true}">{{item.label}}</label>
                                                </li>
                                            </ul>
                                        </nz-dropdown-menu>
                                    </ng-template>
                                </div>
                            </nz-form-control>
                        </nz-form-item>
                    </div>
                    <div class="lay-du-lieu-wrapper">
                        <button nz-button nzSize="small" (click)="getData(true)" class="blueButton"
                            style="padding: 0 10px !important;"><i nz-icon nzType="sync" nzTheme="outline"></i>Lấy dữ
                            liệu</button>
                    </div>
                </div>
                <nz-table [nzNoResult]="null" style="margin-top: 5px;" nzSize="small" #fixedTable [nzData]="listData"
                    [nzWidthConfig]="widthConfig" [nzScroll]="scrollConfig" [nzShowPagination]="totalPages > 1"
                    [nzFrontPagination]="false" [nzTotal]="total" [(nzPageIndex)]="displayData.PageNumber"
                    [(nzPageSize)]="displayData.PageSize" (nzPageIndexChange)="getData()" nzBordered
                    [nzLoading]="isLoading">
                    <thead>
                        <tr>
                            <th nzLeft="0px" nzShowCheckbox [(nzChecked)]="isAllDisplayDataChecked"
                                [nzIndeterminate]="isIndeterminate" (nzCheckedChange)="checkAll($event)">
                            </th>
                            <th nzLeft="50px" nzAlign="center">Tên người nhận</th>
                            <th nzLeft="200px" nzAlign="center">Email người nhận</th>
                            <th nzAlign="center">Ký hiệu mẫu số hóa đơn</th>
                            <th nzAlign="center">Ký hiệu hóa đơn</th>
                            <th nzAlign="center">Ngày hóa đơn</th>
                            <th nzAlign="center">Số hóa đơn</th>
                            <th nzAlign="center">Mã khách hàng</th>
                            <th nzAlign="center">Tên khách hàng</th>
                            <th nzAlign="center">Mã số thuế</th>
                            <th nzAlign="center">Người mua hàng</th>
                            <th nzAlign="center">Loại tiền</th>
                            <th nzAlign="center">Tổng tiền thanh toán</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let data of fixedTable.data" (contextmenu)="contextMenu($event, menu, data)">
                            <td nzLeft="0px" nzShowCheckbox [class.row-selected]="data.selected"
                                [(nzChecked)]="mapOfCheckedId[data.hoaDonDienTuId]" (nzCheckedChange)="refreshStatus()">
                            </td>
                            <td nzLeft="50px" [class.row-selected]="data.selected" nzAlign="center"
                                [ngClass]="{'grayCell': mapOfCheckedId[data.hoaDonDienTuId] != true}"
                                class="cus-form-item">
                                <nz-form-item *ngIf="mapOfCheckedId[data.hoaDonDienTuId]">
                                    <nz-form-control>
                                        <input type="text" nzSize="small" nz-input [(ngModel)]="data.hoTenNguoiNhanHD"
                                            name="hoTenNguoiNhanHD" #hoTenNguoiNhanHD="ngModel" required
                                            class="no-border"
                                            [class.custom-input-error]="hoTenNguoiNhanHD.invalid && (hoTenNguoiNhanHD.dirty || isClickedSave)"
                                            requiredValidator (onInvalid)="inValidForm($event, data)" />
                                        <div class="custom-tooltip-error"
                                            *ngIf="hoTenNguoiNhanHD.errors && (hoTenNguoiNhanHD.dirty || isClickedSave)">
                                            <div *ngIf="hoTenNguoiNhanHD.errors.required">
                                                Không được để trống
                                            </div>
                                        </div>
                                    </nz-form-control>
                                </nz-form-item>
                            </td>
                            <td nzLeft="200px" [class.row-selected]="data.selected" nzAlign="center"
                                [ngClass]="{'grayCell': mapOfCheckedId[data.hoaDonDienTuId] != true}"
                                class="cus-form-item">
                                <nz-form-item *ngIf="mapOfCheckedId[data.hoaDonDienTuId]">
                                    <nz-form-control>
                                        <input type="text" nzSize="small" nz-input [(ngModel)]="data.emailNguoiNhanHD"
                                            name="emailNguoiNhanHD" #emailNguoiNhanHD="ngModel" required
                                            class="no-border"
                                            [class.custom-input-error]="emailNguoiNhanHD.invalid && (emailNguoiNhanHD.dirty || isClickedSave)"
                                            requiredValidator emailValidator (onInvalid)="inValidForm($event, data)" />
                                        <div class="custom-tooltip-error"
                                            *ngIf="emailNguoiNhanHD.errors && (emailNguoiNhanHD.dirty || isClickedSave)">
                                            <div *ngIf="emailNguoiNhanHD.errors.required">
                                                Không được để trống
                                            </div>
                                            <div *ngIf="emailNguoiNhanHD.errors.invalid">
                                                Không đúng định dạng
                                            </div>
                                        </div>
                                    </nz-form-control>
                                </nz-form-item>
                            </td>
                            <td [class.row-selected]="data.selected">
                                {{ data?.mauSo }}
                            </td>
                            <td [class.row-selected]="data.selected">
                                {{ data?.kyHieu }}
                            </td>
                            <td [class.row-selected]="data.selected">
                                {{ data?.ngayHoaDon | date:'dd/MM/yyyy' }}
                            </td>
                            <td [class.row-selected]="data.selected">
                                {{ data?.soHoaDon || '&lt;Chưa cấp số&gt;' }}
                            </td>
                            <td [class.row-selected]="data.selected">
                                {{ data?.maKhachHang }}
                            </td>
                            <td [class.row-selected]="data.selected">
                                {{ data?.tenKhachHang }}
                            </td>
                            <td [class.row-selected]="data.selected">
                                {{ data?.maSoThue }}
                            </td>
                            <td [class.row-selected]="data.selected">
                                {{ data?.hoTenNguoiMuaHang }}
                            </td>
                            <td [class.row-selected]="data.selected">
                                {{ data.maLoaiTien }}
                            </td>
                            <td class="money" [class.row-selected]="data.selected">
                                {{ data?.tongTienThanhToan | formatPrice:true:(data.maLoaiTien === 'VND' ?
                                ddtp.getTienQuyDoi() : ddtp.getTienNgoaiTe()) }}
                            </td>
                        </tr>
                        <tr class="total-footer" *ngIf="total == 0">
                            <td colspan="20">Không có dữ liệu hiển thị.</td>
                        </tr>
                    </tbody>
                    <tfoot *ngIf="total > 0" class="total-footer">
                        <td colspan="3" nzLeft="0px">Số dòng = {{listData.length}}</td>
                        <td colspan="20"></td>
                    </tfoot>
                </nz-table>
            </div>
        </nz-tab>
        <nz-tab nzTitle="2. Kiểm tra dữ liệu" [nzDisabled]="true">
            <nz-table [nzNoResult]="null" style="margin-top: 5px;" nzSize="small" #fixedTable2 [nzData]="listOfSelected"
                [nzWidthConfig]="widthConfig" [nzScroll]="scrollConfig" [nzShowPagination]="false"
                [nzFrontPagination]="false" [nzTotal]="total" [nzPageIndex]="1" [(nzPageSize)]="total" nzBordered
                [nzLoading]="isLoading">
                <thead>
                    <tr>
                        <th nzLeft="0px" nzAlign="center">Tên người nhận</th>
                        <th nzLeft="150px" nzAlign="center">Email người nhận</th>
                        <th nzAlign="center">Ký hiệu mẫu số hóa đơn</th>
                        <th nzAlign="center">Ký hiệu hóa đơn</th>
                        <th nzAlign="center">Ngày hóa đơn</th>
                        <th nzAlign="center">Số hóa đơn</th>
                        <th nzAlign="center">Mã khách hàng</th>
                        <th nzAlign="center">Tên khách hàng</th>
                        <th nzAlign="center">Mã số thuế</th>
                        <th nzAlign="center">Người mua hàng</th>
                        <th nzAlign="center">Loại tiền</th>
                        <th nzAlign="center">Tổng tiền thanh toán</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let data of fixedTable2.data" (contextmenu)="contextMenu($event, menu, data)">
                        <td nzLeft="0px" [ngClass]="{'grayCell': mapOfCheckedId[data.hoaDonDienTuId] != true}">
                            {{data.hoTenNguoiNhanHD}}
                        </td>
                        <td nzLeft="150px" [ngClass]="{'grayCell': mapOfCheckedId[data.hoaDonDienTuId] != true}">
                            {{data.emailNguoiNhanHD}}
                        </td>
                        <td>
                            {{ data?.mauSo }}
                        </td>
                        <td>
                            {{ data?.kyHieu }}
                        </td>
                        <td>
                            {{ data?.ngayHoaDon | date:'dd/MM/yyyy' }}
                        </td>
                        <td>
                            {{ data?.soHoaDon || '&lt;Chưa cấp số&gt;' }}
                        </td>
                        <td>
                            {{ data?.maKhachHang }}
                        </td>
                        <td>
                            {{ data?.tenKhachHang }}
                        </td>
                        <td>
                            {{ data?.maSoThue }}
                        </td>
                        <td>
                            {{ data?.hoTenNguoiMuaHang }}
                        </td>
                        <td>
                            {{ data.maLoaiTien }}
                        </td>
                        <td class="money">
                            {{ data?.tongTienThanhToan | formatPrice:true:(data.maLoaiTien === 'VND' ?
                            ddtp.getTienQuyDoi() : ddtp.getTienNgoaiTe()) }}
                        </td>
                    </tr>
                    <tr class="total-footer" *ngIf="listOfSelected.length == 0">
                        <td colspan="20">Không có dữ liệu hiển thị.</td>
                    </tr>
                </tbody>
                <tfoot *ngIf="listOfSelected.length > 0" class="total-footer">
                    <td colspan="2" nzLeft="0px">Số dòng = {{listOfSelected.length}}</td>
                    <td colspan="20"></td>
                </tfoot>
            </nz-table>
        </nz-tab>
        <nz-tab nzTitle="3. Kết quả thực hiện" [nzDisabled]="true">
            <div class="inner-content">
                <div style="font-size: larger;"><strong>Kết quả thực hiện</strong></div>
                <div *ngIf="numberSuccess > 0">
                    • Gửi {{titleHoaDon}} cho khách hàng thành công <strong>{{ numberSuccess }}/{{ numberTotal }}</strong> hóa đơn
                </div>
                <ng-container *ngIf="listError.length > 0">
                    <div style="color: red !important;">
                        • Số lượng gửi {{titleHoaDon}} cho khách hàng lỗi: <strong>{{ listError.length }}/{{ numberTotal }}</strong> hóa đơn
                    </div>
                    <div style="margin-top: 20px" >
                        <span #taiTep>
                            <button class ="greenButton"[nzLoading]="isLoading" nzSize="small" nz-button nzType="default" nz-dropdown [nzOverlayStyle]="{width: '100%'}" [nzDropdownMenu]="fileTypeMenu"
                            (click)="downloadFilesError()" [disabled]="listError.length<=0">
                            <i nz-icon nzType="vertical-align-bottom" nzTheme="outline"></i>
                            Tải tệp gửi {{titleHoaDon}} cho khách hàng lỗi
                        </button>
                        </span>
                    <nz-dropdown-menu #fileTypeMenu="nzDropdownMenu" style="width: 100% !important">
                        <ul nz-menu [style.min-width.px]="taiTep.offsetWidth">
                            <li nz-menu-item (click)="downloadFilesError()" style="width: 100% !important;
                            ">
                                <img [style.visibility]="'visible'" width="17"
                                height="15" src="assets/xlsx.png" /> Excel
                            </li>
                        </ul>
                    </nz-dropdown-menu>
                    </div>
                </ng-container>
            </div>
        </nz-tab>
    </nz-tabset>
</nz-spin>

<nz-dropdown-menu #menu="nzDropdownMenu">
    <ng-container>
        <ul nz-menu class="menu-rightclick">
            <li nz-menu-item
                [nzDisabled]="(permission != true && ((!isPhieuXuatKho &&thaoTacs.indexOf('HD_FULL') < 0 && thaoTacs.indexOf('HD_UPDATE') < 0)  || (isPhieuXuatKho&& thaoTacs.indexOf('PXK_FULL') < 0 && thaoTacs.indexOf('PXK_UPDATE') < 0)))
                || (dataSelected && dataSelected.trangThaiQuyTrinh !== 0 && dataSelected.trangThaiQuyTrinh != 2 && dataSelected.trangThaiQuyTrinh != 4)"
                (click)="$event.target.className.includes('ant-dropdown-menu-item-disabled') ? $event.preventDefault() : clickSua(false, false, dataSelected,$event)">
                Sửa
            </li>
            <li nz-menu-item
                [nzDisabled]="(permission != true && ((!isPhieuXuatKho &&thaoTacs.indexOf('HD_FULL') < 0 && thaoTacs.indexOf('HD_VIEW') < 0)  || (isPhieuXuatKho&& thaoTacs.indexOf('PXK_FULL') < 0 && thaoTacs.indexOf('PXK_VIEW') < 0)))"
                (click)="$event.target.className.includes('ant-dropdown-menu-item-disabled') ? $event.preventDefault() : viewReceipt(dataSelected)">
                Xem hóa đơn
            </li>
        </ul>
    </ng-container>
</nz-dropdown-menu>

<div style="text-align: right;margin-bottom: 5px;padding: 8px 0px;border: 1px solid #e0e0e0;">
    <nz-button-group>
        <button [disabled]="listError.length > 0" nzSize="small" nz-button nzType="default" (click)="clickBack()"
            *ngIf="selectedIndex>0 && selectedIndex<2" [nzLoading]="isLoading"
            [class.blueButton]="!(listError.length > 0)"><i nz-icon nzType="arrow-left" nzTheme="outline"></i>
            Quay lại
        </button>
        <button nzSize="small" nz-button nzType="default" (click)="clickNext()" *ngIf="selectedIndex < 2"
            [nzLoading]="isLoading" style="margin-right: 12px;"
            [ngClass]="{'blueButton': selectedIndex === 0, 'greenButton': selectedIndex === 1}">
            <ng-container *ngIf="selectedIndex === 0">
                Tiếp tục<i nz-icon nzType="arrow-right" nzTheme="outline"></i>
            </ng-container>
            <ng-container *ngIf="selectedIndex === 1">
                <i nz-icon nzType="check" nzTheme="outline"></i> Thực hiện
            </ng-container>
        </button>
        <button nzSize="small" nz-button nzType="default" (click)="thucHienLai()"
            *ngIf="selectedIndex === 2 && listError.length > 0" [nzLoading]="isLoading" style="margin-right: 12px;"
            class="greenButton">
            <i nz-icon nzType="reload" nzTheme="outline"></i> Thực hiện lại
        </button>
        <button class="filterDefaultButton" nzSize="small" nz-button nzType="default" (click)="phatHanhTiep()"
            *ngIf="selectedIndex == 2" [nzLoading]="isLoading"><i nz-icon nzType="select"
                nzTheme="outline"></i>&nbsp;Gửi {{titleHoaDon}} tiếp</button>
    </nz-button-group>
</div>