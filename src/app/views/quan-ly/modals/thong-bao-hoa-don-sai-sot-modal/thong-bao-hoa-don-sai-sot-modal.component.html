<nz-spin [nzSpinning]="spinning">
    <div nz-row id="backgroundLayout">
        <div nz-row style="margin-left: 120px !important; margin-right: 120px!important;margin-top: 2px; margin-bottom: 6px; float:inline-start">
            <div nz-row>
                <div nz-col nzSpan="8">
                    <button class="blueButton disabled-button-state-v2" nz-button nz-dropdown [nzDropdownMenu]="menuXuatKhau" nzSize="small" [nzDisabled]="!(daLuu || isView) || (permission != true  && thaoTacs.indexOf('MNG_FULL') < 0 && thaoTacs.indexOf('MNG_EXPORT') < 0) ">
    <i nz-icon nzType="vertical-align-bottom" nzTheme="outline"></i>Xuất khẩu<i nz-icon nzType="down"></i>
  </button>
                    <nz-dropdown-menu #menuXuatKhau="nzDropdownMenu">
                        <ul nz-menu style="min-width: 110px !important;">
                            <li nz-menu-item (click)="downloadFile('pdf')">
                                <img src="../../../../../../assets/pdf.png" width="15" height="15" />&nbsp;<span>PDF</span>
                            </li>
                            <li nz-menu-item (click)="downloadFile('docx')">
                                <img src="../../../../../../assets/docx.png" width="15" height="15" />&nbsp;<span>DOCX</span>
                            </li>
                            <!--
      <li nz-menu-item (click) = "downloadFile('xml')">
        <img src="../../../../../../assets/xml.png" width="15" height="15" />&nbsp;<span>XML (chưa ký)</span>
      </li>
      -->
                            <li nz-menu-item (click)="downloadFile('xml', true)" *ngIf="this.mainForm.get('fileXMLDaKy').value != null && this.mainForm.get('fileXMLDaKy').value != ''">
                                <img src="../../../../../../assets/xml.png" width="15" height="15" />&nbsp;<span>XML</span>
                            </li>
                        </ul>
                    </nz-dropdown-menu>&nbsp;
                    <button class="button-cancel disabled-button-state-v2" nz-button nzType="default" nzSize="small" *ngIf="!daKyVaGuiCQT" [disabled]="daKyVaGuiCQT || autoSign || (isCopy && !daLuu) || (isEdit && !daLuu) || daClickSua || (!isEdit && !isCopy && !isView && !daLuu) || (permission != true  && thaoTacs.indexOf('MNG_FULL') < 0 && thaoTacs.indexOf('MNG_SEND') < 0) "
                        (click)="sendMessageToServer()"><span class="material-icons-outlined" style="transform: rotate(315deg);">send</span>&nbsp;Ký và Gửi</button>
                </div>
                <div nz-col nzSpan="16" style="text-align: right;">
                    <button class="blueButton disabled-button-state-v2" *ngIf="!isView || (isView && !daKyVaGuiCQT)" nz-button nzType="default" nzSize="small" [disabled]="((!isEdit && !isCopy && !isView && !daLuu) || (isEdit && !daLuu) || (isCopy && !daLuu) || daClickSua || daKyVaGuiCQT || daXoa || autoSign) || (permission != true  && thaoTacs.indexOf('MNG_FULL') < 0 && thaoTacs.indexOf('MNG_UPDATE') < 0) "
                        (click)="clickSua()">
  <i nz-icon nzSize="small" nzType="edit"></i>Sửa</button>&nbsp;

                    <button class="button-cancel disabled-button-state-v2" *ngIf="!isView || (isView && !daKyVaGuiCQT)" nz-button nzType="default" nzSize="small" [disabled]="((!isEdit && !isCopy && !isView && !daLuu) || (isEdit && !daLuu) || (isCopy && !daLuu) || daClickSua || daKyVaGuiCQT || daXoa || autoSign) || (permission != true  && thaoTacs.indexOf('MNG_FULL') < 0 && thaoTacs.indexOf('MNG_DELETE') < 0)"
                        [ngClass]="{'disabled-button-state':
  ((!isEdit && !isCopy && !isView && !daLuu) || (isEdit && !daLuu) || (isCopy && !daLuu) || daClickSua || daKyVaGuiCQT || daXoa || autoSign || (permission != true  && thaoTacs.indexOf('MNG_FULL') < 0 && thaoTacs.indexOf('MNG_DELETE') < 0) ), 'button-close': !((!isEdit && !isCopy && !isView && !daLuu) || (isEdit && !daLuu) || (isCopy && !daLuu) || daClickSua || daKyVaGuiCQT || daXoa || autoSign || (permission != true  && thaoTacs.indexOf('MNG_FULL') < 0 && thaoTacs.indexOf('MNG_DELETE') < 0))}"
                        (click)="clickXoa()">
  <i nz-icon nzSize="small" nzType="delete"></i>Xóa</button>&nbsp;

                    <button class="greenButton disabled-button-state-v2" *ngIf="!isView || (isView && !daKyVaGuiCQT)" nz-button nzType="default" (click)="submitForm()" nzSize="small" [disabled]="daLuu || daKyVaGuiCQT || isView || autoSign" [ngClass]="{'disabled-button-state': daLuu || daKyVaGuiCQT || isView || autoSign, 'button-save': !(daLuu || daKyVaGuiCQT || isView || autoSign)}">
    <i nz-icon nzSize="small" nzType="save"></i>Lưu</button>&nbsp;

                    <button nz-button nzType="default" class="button-cancel disabled-button-state-v2" (click)="closeModal()" nzSize="small" style="padding: 0px 8px!important"><i nz-icon nzSize="small" nzType="close"></i>Đóng</button>
                </div>
            </div>
        </div>
        <div nz-row id="layoutContent">
            <form nz-form [formGroup]="mainForm" *ngIf="mainForm" class="container" id="formLayout">
                <div>
                    <h1 style="text-align: center;text-transform: uppercase;"><strong>Cộng hòa xã hội chủ nghĩa Việt Nam</strong></h1>
                    <h2 style="text-align: center;"><strong>Độc lập - Tự do - Hạnh phúc</strong></h2>
                    <span style="padding: 5px 15px; border: #E5E5E5 solid 1px; position: absolute; z-index: 10; right: 60px; top: 5px">Mẫu số 04/SS-HĐĐT</span>
                </div>
                <h3 style="text-align: center; margin-top: -5px; display: block;"><strong>_____________________</strong></h3>
                <h1 style="text-align: center;text-transform: uppercase; margin-bottom: 8px; display: block;"><strong>THÔNG BÁO HÓA ĐƠN ĐIỆN TỬ CÓ SAI SÓT</strong></h1>

                <nz-form-item>
                    <nz-form-label [nzSm]="3" [nzXs]="24">Loại thông báo</nz-form-label>
                    <nz-form-control [nzSm]="21" [nzXs]="24" [ngClass]="{'notOpacityRadio': 1 == 1}">
                        <nz-radio-group formControlName="loaiThongBaoHienThi" [nzDisabled]="true" style="margin-bottom: -10px!important" (ngModelChange)="changeLoaiThongBao($event)">
                            <label nz-radio nzValue="1">Thông báo hủy/giải trình của NNT</label>
                            <label nz-radio nzValue="3">Thông báo hủy/giải trình của NNT KHÁC</label>
                            <label nz-radio nzValue="2">Thông báo hủy/giải trình của NNT theo thông báo của CQT</label>
                        </nz-radio-group>
                        <div style="float: right">
                            <span>Số thông báo: </span>
                            <input nz-input nzSize="small" type="text" formControlName="soThongBaoSaiSot" readonly style="background-color: #F2F2F2; width: 170px!important; display: inline-block!important;" />
                        </div>
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label [nzSm]="3" [nzXs]="24" nzFor="kinhGui">Kính gửi</nz-form-label>
                    <nz-form-control [nzSm]="21" [nzXs]="24">
                        <input style="width: 100%;" nz-input nzSize="small" type="text" formControlName="kinhGui" readonly style="background-color: #F2F2F2" />
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label [nzSm]="3" [nzXs]="24" nzFor="tenNguoiNopThue">Tên người nộp thuế</nz-form-label>
                    <nz-form-control [nzSm]="21" [nzXs]="24">
                        <input style="width: 100%;" nz-input nzSize="small" type="text" formControlName="tenNguoiNopThue" readonly style="background-color: #F2F2F2" maxlength="400" />
                    </nz-form-control>
                </nz-form-item>

                <nz-form-item>
                    <nz-form-label [nzSm]="3" [nzXs]="24" nzFor="maSoThue">Mã số thuế</nz-form-label>
                    <nz-form-control [nzSm]="21" [nzXs]="24">
                        <input style="width: 100%;" nz-input nzSize="small" type="text" formControlName="maSoThue" readonly style="background-color: #F2F2F2" maxlength="14" />
                    </nz-form-control>
                </nz-form-item>

                <div>
                    Người nộp thuế thông báo về việc hóa đơn điện tử có sai sót như sau:
                </div>

                <div>
                    <nz-table [nzNoResult]="null" style="margin-top: 5px;" nzSize="small" #fixedTable [nzData]="this.mainForm.get('hoaDonSaiSots').value" [nzScroll]="{ x: '910px', y: '280px' }" [nzShowPagination]="false" [nzFrontPagination]="false" [nzTotal]="totalRecords"
                        [nzPageIndex]="1" [(nzPageSize)]="totalRecords" nzBordered>
                        <thead>
                            <tr>
                                <th nzAlign="center" nzWidth="50px">STT</th>
                                <th nzAlign="center" nzWidth="250px">Mã CQT cấp</th>
                                <th nzAlign="center" nzWidth="160px">Ký hiệu mẫu số hóa đơn<br>và ký hiệu hóa đơn</th>
                                <th nzAlign="center" nzWidth="90px">Số hóa đơn<br>điện tử</th>
                                <th nzAlign="center" nzWidth="85px">Ngày lập<br>hóa đơn</th>
                                <th nzAlign="center" nzWidth="100px">Loại áp dụng<br>hóa đơn điện tử</th>
                                <th nzAlign="center" nzWidth="112px">Hủy/Điều chỉnh/<br>Thay thế/Giải trình</th>
                                <th nzAlign="center" nzWidth="225px">Lý do</th>
                            </tr>
                            <tr>
                                <th nzAlign="center">1</th>
                                <th nzAlign="center">2</th>
                                <th nzAlign="center">3</th>
                                <th nzAlign="center">4</th>
                                <th nzAlign="center">5</th>
                                <th nzAlign="center">6</th>
                                <th nzAlign="center">7</th>
                                <th nzAlign="center">8</th>
                            </tr>
                        </thead>
                        <tbody formArrayName="hoaDonSaiSots">
                            <tr *ngFor="let data of mainForm.get('hoaDonSaiSots')['controls']; let i = index" [formGroupName]="i">
                                <td nzAlign="center" style="line-height: 24px;">
                                    <span class="centerInputText" style="width: 100%; display: block;">{{i + 1}}</span>
                                </td>
                                <td>
                                    <span>{{data.value.maCQTCap}}</span>
                                    <!--
                    <nz-form-item>
                      <nz-form-control [nzSm]="24" [nzXs]="24">
                        <input nz-input nzSize="small" formControlName="maCQTCap" maxlength = "50" readonly>
                      </nz-form-control>
                    </nz-form-item>-->
                                </td>
                                <td>
                                    {{data.value.mauVaKyHieuHoaDon}}
                                    <!--
                    <nz-form-item>
                      <nz-form-control [nzSm]="24" [nzXs]="24">
                        <input nz-input nzSize="small" formControlName="mauVaKyHieuHoaDon" maxlength = "100" readonly>
                      </nz-form-control>
                    </nz-form-item>
                    -->
                                </td>
                                <td>
                                    {{data.value.soHoaDon}}
                                    <!-- <nz-form-item>
                      <nz-form-control [nzSm]="24" [nzXs]="24">
                        <input nz-input nzSize="small" formControlName="soHoaDon" maxlength = "50" readonly>
                      </nz-form-control>
                    </nz-form-item> -->
                                </td>
                                <td nzAlign="center">
                                    {{data.value.ngayLapHoaDonText}}
                                    <!-- <nz-form-item>
                      <nz-form-control [nzSm]="24" [nzXs]="24">
                        <input nz-input nzSize="small" type = "text" formControlName="ngayLapHoaDonText" class = "centerInputText" readonly>
                      </nz-form-control>
                    </nz-form-item> -->
                                </td>
                                <td nzAlign="center" [title]="this.getTitleLoaiHoaDon(data.value.loaiApDungHoaDon)">
                                    {{data.value.loaiApDungHoaDon}}
                                    <!-- <nz-form-item>
                      <nz-form-control [nzSm]="24" [nzXs]="24">
                        <input nz-input nzSize="small" formControlName="loaiApDungHoaDon" maxlength = "50"  class = "centerInputText" readonly>
                      </nz-form-control>
                    </nz-form-item> -->
                                </td>
                                <td>
                                    {{data.value.phanLoaiHDSaiSotText}}
                                    <!-- <nz-form-item>
                      <nz-form-control [nzSm]="24" [nzXs]="24">
                        <input nz-input nzSize="small" formControlName="phanLoaiHDSaiSotText" readonly>
                      </nz-form-control>
                    </nz-form-item> -->
                                </td>
                                <td style="white-space: pre-wrap !important;">
                                    <span>{{data.value.lyDo}}</span>
                                    <!-- <nz-form-item>
                      <nz-form-control [nzSm]="24" [nzXs]="24">
                        <input nz-input nzSize="small" type="text" formControlName="lyDo" maxlength = "255" [title] = "data.value.lyDo" readonly>
                      </nz-form-control>
                    </nz-form-item> -->
                                </td>
                            </tr>
                        </tbody>
                        <tfoot *ngIf="totalRecords == 0">
                            <tr class="total-footer">
                                <td colspan="8">Không có dữ liệu hiển thị.</td>
                            </tr>
                        </tfoot>
                    </nz-table>
                </div>

                <nz-form-item>
                    <nz-form-control [nzSm]="12" [nzXs]="24">
                        <div style="margin-top: 3px; margin-bottom: 3px;">
                            <button nz-button nzType="default" *ngIf="!daKyVaGuiCQT" [disabled]="daLuu || autoSign" [ngClass]="{'disabled-button-state-v2': daLuu || autoSign, 'blueButton': daLuu === false && autoSign === false}" (click)="chonHoaDonCoSaiSot()" nzSize="small">
                <span *ngIf = "loaiThongBao == 1 && !isView">
                  <i nz-icon nzSize="small" nzType="select"></i>&nbsp;
                  Chọn hóa đơn điện tử có sai sót</span>
                <span *ngIf = "loaiThongBao == 2 && !isView">
                  <i nz-icon nzSize="small" nzType="select"></i>&nbsp;
                  Chọn thông báo của CQT</span>
                <span *ngIf = "loaiThongBao == 3 && !isView">
                  <i nz-icon nzSize="small" nzType="select"></i>&nbsp;
                  Nhập thông tin hóa đơn khác có sai sót</span>
                <span *ngIf = "isView">
                  <i nz-icon nzSize="small" nzType="eye"></i>&nbsp;Xem chi tiết</span>
              </button>

                            <button nz-button nzType="default" *ngIf="daKyVaGuiCQT && (loaiThongBao != 3 || isNew)" class="blueButton" (click)="chonHoaDonCoSaiSot()" nzSize="small">
                <span><i nz-icon nzSize="small" nzType="eye"></i>&nbsp;Xem chi tiết</span>
              </button>
                        </div>

                        <div style="margin-top: 5px;margin-bottom: 10px;">
                            Ghi chú: (2): Mã CQT cấp đối với hóa đơn có mã của CQT, hóa đơn không mã của CQT để trống.
                        </div>

                        <nz-form-item>
                            <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="diaDanh">Địa danh</nz-form-label>
                            <nz-form-control [nzSm]="8" [nzXs]="24">
                                <nz-select style="width: 100%;" nzSize="small" formControlName="diaDanh" nzShowSearch nzPlaceHolder="Chọn địa danh" [nzDisabled]="daLuu || isView">
                                    <nz-option *ngFor="let item of listDiaDanh" [nzLabel]="item.name" [nzValue]="item.code"></nz-option>
                                </nz-select>
                            </nz-form-control>
                        </nz-form-item>

                        <nz-form-item>
                            <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="ngayLap">Ngày lập</nz-form-label>
                            <nz-form-control [nzSm]="8" [nzXs]="24">
                                <input nz-input nzSize="small" type="date" formControlName="ngayLap" max="2999-12-31" [disabled]="daLuu || isView" [readonly]="daLuu || isView" (blur)="kiemTraNgayLapHopLe()" />
                            </nz-form-control>
                        </nz-form-item>

                        <nz-form-item>
                            <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="daiDienNguoiNopThue">Người nộp thuế</nz-form-label>
                            <nz-form-control [nzSm]="8" [nzXs]="24">
                                <input nz-input nzSize="small" type="text" formControlName="daiDienNguoiNopThue" maxlength="50" [disabled]="daLuu || isView" [readonly]="daLuu || isView" />
                            </nz-form-control>
                        </nz-form-item>
                    </nz-form-control>

                    <nz-form-control [nzSm]="12" [nzXs]="24">
                        <div style="width: 350px; margin-top: 8px; margin-left: auto; margin-right: 0; text-align: center;">
                            {{getChuoiDiaDanhNgayThang()}}
                        </div>
                        <div style="width: 350px; text-transform: uppercase; text-align: center; font-weight: bold; margin-left: auto; margin-right: 0;">
                            NGƯỜI NỘP THUẾ
                        </div>
                        <div style="width: 350px; text-align: center; margin-left: auto; margin-right: 0;">
                            (Chữ ký số, chữ ký điện tử của người nộp thuế)
                        </div>
                        <div style="width: 350px; margin-top: 3px; margin-left: auto; margin-right: 0; text-align: center;">
                            <app-chu-ky-dien-tu [tenDonVi]="mainForm.get('fileXMLDaKy').value ? mainForm.get('tenNguoiNopThue').value: ''" [ngayKy]="mainForm.get('fileXMLDaKy').value ? getNgayKyGui() : ''"></app-chu-ky-dien-tu>

                            <!-- <div class="sign-box" *ngIf = "this.mainForm.get('fileXMLDaKy').value != null && this.mainForm.get('fileXMLDaKy').value != ''">
                <div>Ký bởi: <span style="text-transform: uppercase;">{{this.mainForm.get('tenNguoiNopThue').value}}</span></div>
                <div>Ngày ký: {{getNgayKyGui()}}</div>
              </div> -->
                        </div>
                    </nz-form-control>
                </nz-form-item>
            </form>
        </div>

    </div>

</nz-spin>
